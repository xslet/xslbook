<?xml version="1.0" encoding="UTF-8"?><!-- xslbook.xsl 0.1 Copyright (C) 2022 xslet project MIT License --><xsl:stylesheet xmlns:book="https://github.com/xslet/2020/xslbook" xmlns:do="https://github.com/xslet/2020/xsldo" xmlns:ut="https://github.com/xslet/2020/xslutil" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"><xsl:strip-space elements="*"/><xsl:param name="ut:apos">'</xsl:param><xsl:param name="ut:quot">"</xsl:param><xsl:param name="ut:true" select="string(true())"/><xsl:param name="ut:unknown_namespace">&#x86;-&#x87;</xsl:param><xsl:param name="do:_path_sep">&#x86;/&#x87;</xsl:param><xsl:param name="do:_ns_sep">&#x86;:&#x87;</xsl:param><xsl:param name="do:_cond_sep">&#x86;?&#x87;</xsl:param><xsl:param name="do:_cond_or_sep">&#x96;|&#x97;</xsl:param><xsl:param name="do:_cond_and_sep">&#x96;,&#x97;</xsl:param><xsl:param name="do:_cond_path_sep">&#x96;/&#x97;</xsl:param><xsl:param name="do:_cond_op_sep">&#x96;=&#x97;</xsl:param><xsl:param name="do:_object_sep">&#x86;;&#x87;</xsl:param><xsl:param name="book:xsl_url"><xsl:call-template name="ut:get_xsl_url"/></xsl:param><xsl:param name="book:xsl_dir"><xsl:call-template name="ut:get_dir_from_url"><xsl:with-param name="url" select="$book:xsl_url"/></xsl:call-template></xsl:param><xsl:template match="/xslbook"><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"/></xsl:variable><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><title><xsl:call-template name="book:get_window_title"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></title><xsl:call-template name="book:use_css"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></head><body><main><xsl:apply-templates select="title|body|subtitle[not(@top-of or @left-of or @right-of or @bottom-of)]" mode="xslbook"><xsl:with-param name="data_url" select="$_data_url"/></xsl:apply-templates></main></body></html></xsl:template><xsl:template name="book:use_css"><xsl:param name="data_url"/><link rel="stylesheet" href="{$book:xsl_dir}/xslbook.css" type="text/css"/><xsl:apply-templates select="style" mode="xslbook"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></xsl:template><xsl:template match="style" mode="xslbook"><xsl:param name="data_url"/><xsl:variable name="_href"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">href</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><link rel="stylesheet" href="{$_href}" type="text/css"/></xsl:template><xsl:template match="b|u|i|s|sup|sub|br"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:element name="{local-name()}"><xsl:attribute name="id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:attribute><xsl:apply-templates><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:element></xsl:template><xsl:template match="w"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:element name="u"><xsl:attribute name="id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:attribute><xsl:attribute name="class">wavy</xsl:attribute><xsl:apply-templates><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:element></xsl:template><xsl:template match="p"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><p><xsl:attribute name="id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:attribute><xsl:apply-templates><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></p></xsl:template><xsl:template name="ut:get_xsl_url"><xsl:param name="pi" select="/processing-instruction('xml-stylesheet')"/><xsl:variable name="QUOT">"</xsl:variable><xsl:variable name="APOS">'</xsl:variable><xsl:variable name="s1" select="substring-after($pi, 'href')"/><xsl:if test="normalize-space(substring-before($s1, '=')) = ''"><xsl:variable name="s2" select="substring-after($s1, '=')"/><xsl:choose><xsl:when test="substring($s2, 1, 1) = $QUOT"><xsl:value-of select="translate(substring-before(substring-after($s2, $QUOT), $QUOT), '\', '/')"/></xsl:when><xsl:when test="substring($s2, 1, 1) = $APOS"><xsl:value-of select="translate(substring-before(substring-after($s2, $APOS), $APOS), '\', '/')"/></xsl:when><xsl:otherwise><xsl:variable name="s3" select="normalize-space($s2)"/><xsl:choose><xsl:when test="substring($s3, 1, 1) = $QUOT"><xsl:value-of select="translate(substring-before(substring-after($s2, $QUOT), $QUOT), '\', '/')"/></xsl:when><xsl:when test="substring($s3, 1, 1) = $APOS"><xsl:value-of select="translate(substring-before(substring-after($s2, $APOS), $APOS), '\', '/')"/></xsl:when></xsl:choose></xsl:otherwise></xsl:choose></xsl:if></xsl:template><xsl:template name="ut:count"><xsl:param name="string"/><xsl:param name="target"/><xsl:choose><xsl:when test="string-length($string) = 0">0</xsl:when><xsl:when test="string-length($target) = 0">0</xsl:when><xsl:when test="starts-with($string, $target)"><xsl:variable name="_count"><xsl:variable name="_next_bgn" select="string-length($target) + 1"/><xsl:call-template name="ut:count"><xsl:with-param name="string" select="substring($string, $_next_bgn)"/><xsl:with-param name="target" select="$target"/></xsl:call-template></xsl:variable><xsl:value-of select="$_count + 1"/></xsl:when><xsl:otherwise><xsl:call-template name="ut:count"><xsl:with-param name="string" select="substring($string, 2)"/><xsl:with-param name="target" select="$target"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:get_namespace_uri"><xsl:param name="prefix"/><xsl:variable name="_ns" select="namespace::*[name() = $prefix]"/><xsl:choose><xsl:when test="string-length($_ns) &gt; 0"><xsl:value-of select="$_ns"/></xsl:when><xsl:otherwise><xsl:variable name="_ns2" select="namespace-uri(//*[name() = concat($prefix,':',local-name())])"/><xsl:choose><xsl:when test="string-length($_ns2) &gt; 0"><xsl:value-of select="$_ns2"/></xsl:when><xsl:when test="string-length($prefix) &gt; 0"><xsl:value-of select="$ut:unknown_namespace"/></xsl:when></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:validate"><xsl:param name="string"/><xsl:param name="forbidden"/><xsl:param name="default"/><xsl:variable name="_s" select="translate($string, $forbidden, '')"/><xsl:choose><xsl:when test="string-length($_s) = string-length($string)"><xsl:value-of select="$string"/></xsl:when><xsl:otherwise><xsl:value-of select="$default"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:replace"><xsl:param name="string"/><xsl:param name="target"/><xsl:param name="replacement"/><xsl:variable name="_lenT" select="string-length($target)"/><xsl:choose><xsl:when test="$_lenT = 0"><xsl:value-of select="$string"/></xsl:when><xsl:when test="starts-with($string, $target)"><xsl:value-of select="$replacement"/><xsl:call-template name="ut:replace"><xsl:with-param name="string" select="substring($string, $_lenT + 1)"/><xsl:with-param name="target" select="$target"/><xsl:with-param name="replacement" select="$replacement"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:variable name="_before" select="substring-before($string, $target)"/><xsl:choose><xsl:when test="$_before = ''"><xsl:value-of select="$string"/></xsl:when><xsl:otherwise><xsl:variable name="_lenB" select="string-length($_before)"/><xsl:variable name="_posA" select="$_lenB + $_lenT + 1"/><xsl:value-of select="$_before"/><xsl:value-of select="$replacement"/><xsl:call-template name="ut:replace"><xsl:with-param name="string" select="substring($string, $_posA)"/><xsl:with-param name="target" select="$target"/><xsl:with-param name="replacement" select="$replacement"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:is_absolute_url"><xsl:param name="url"/><xsl:choose><xsl:when test="string-length($url) = 0"><xsl:value-of select="$ut:true"/></xsl:when><xsl:when test="contains($url, ':')"><xsl:value-of select="$ut:true"/></xsl:when><xsl:when test="starts-with($url, '/')"><xsl:value-of select="$ut:true"/></xsl:when></xsl:choose></xsl:template><xsl:template name="ut:ends_with"><xsl:param name="string"/><xsl:param name="suffix"/><xsl:variable name="_len1" select="string-length($suffix)"/><xsl:choose><xsl:when test="$_len1 = 0"><xsl:value-of select="$ut:true"/></xsl:when><xsl:otherwise><xsl:variable name="_len0" select="string-length($string)"/><xsl:variable name="_len2" select="$_len0 - $_len1"/><xsl:variable name="_ends" select="substring($string, $_len2 + 1)"/><xsl:if test="$_ends = $suffix"><xsl:value-of select="$ut:true"/></xsl:if></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:get_dir_from_url"><xsl:param name="url"/><xsl:choose><xsl:when test="not(contains($url, '/'))">.</xsl:when><xsl:otherwise><xsl:call-template name="ut:_get_dir_from_url_r"><xsl:with-param name="url" select="$url"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:_get_dir_from_url_r"><xsl:param name="url"/><xsl:value-of select="substring-before($url, '/')"/><xsl:variable name="suburl" select="substring-after($url, '/')"/><xsl:if test="string-length($suburl) &gt; 0"><xsl:variable name="subdir"><xsl:call-template name="ut:_get_dir_from_url_r"><xsl:with-param name="url" select="$suburl"/></xsl:call-template></xsl:variable><xsl:if test="string-length($subdir) &gt; 0"><xsl:value-of select="concat('/', $subdir)"/></xsl:if></xsl:if></xsl:template><xsl:template name="ut:repeat"><xsl:param name="string"/><xsl:param name="count"/><xsl:if test="$count &gt; 0"><xsl:value-of select="$string"/><xsl:call-template name="ut:repeat"><xsl:with-param name="string" select="$string"/><xsl:with-param name="count" select="$count - 1"/></xsl:call-template></xsl:if></xsl:template><xsl:template name="ut:trim_start"><xsl:param name="string"/><xsl:param name="target"/><xsl:variable name="_lenS" select="string-length($string)"/><xsl:variable name="_lenT" select="string-length($target)"/><xsl:choose><xsl:when test="$_lenS = 0"/><xsl:when test="$_lenT = 0"><xsl:variable name="_first" select="substring($string, 1, 1)"/><xsl:choose><xsl:when test="normalize-space($_first) = ''"><xsl:call-template name="ut:trim_start"><xsl:with-param name="string" select="substring($string, 2)"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:value-of select="$string"/></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:choose><xsl:when test="starts-with($string, $target)"><xsl:call-template name="ut:trim_start"><xsl:with-param name="string" select="substring($string, $_lenT + 1)"/><xsl:with-param name="target" select="$target"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:value-of select="$string"/></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:trim_end"><xsl:param name="string"/><xsl:param name="target"/><xsl:variable name="_lenS" select="string-length($string)"/><xsl:variable name="_lenT" select="string-length($target)"/><xsl:choose><xsl:when test="$_lenS = 0"/><xsl:when test="$_lenT = 0"><xsl:variable name="_last" select="substring($string, $_lenS, 1)"/><xsl:choose><xsl:when test="normalize-space($_last) = ''"><xsl:call-template name="ut:trim_end"><xsl:with-param name="string" select="substring($string, 1, $_lenS - 1)"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:value-of select="$string"/></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:choose><xsl:when test="substring($string, $_lenS - $_lenT + 1) = $target"><xsl:call-template name="ut:trim_end"><xsl:with-param name="string" select="substring($string, 1, $_lenS - $_lenT)"/><xsl:with-param name="target" select="$target"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:value-of select="$string"/></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:trim"><xsl:param name="string"/><xsl:param name="target"/><xsl:variable name="_str"><xsl:call-template name="ut:trim_start"><xsl:with-param name="string" select="$string"/><xsl:with-param name="target" select="$target"/></xsl:call-template></xsl:variable><xsl:call-template name="ut:trim_end"><xsl:with-param name="string" select="$_str"/><xsl:with-param name="target" select="$target"/></xsl:call-template></xsl:template><xsl:template name="do:for_by_path"><xsl:param name="path"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="index_set"/><xsl:param name="index_id"/><xsl:param name="reverse"/><xsl:param name="sort_name"/><xsl:param name="sort_dir"/><xsl:param name="sort_type"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_expath"><xsl:call-template name="do:expand_path"><xsl:with-param name="path" select="$path"/><xsl:with-param name="what">id</xsl:with-param></xsl:call-template></xsl:variable><xsl:call-template name="do:for_by_expath"><xsl:with-param name="expath" select="$_expath"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="index_set" select="$index_set"/><xsl:with-param name="index_id" select="$index_id"/><xsl:with-param name="reverse" select="$reverse"/><xsl:with-param name="sort_name" select="$sort_name"/><xsl:with-param name="sort_dir" select="$sort_dir"/><xsl:with-param name="sort_type" select="$sort_type"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:template><xsl:template name="do:for_by_expath"><xsl:param name="expath"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="index_set"/><xsl:param name="index_id"/><xsl:param name="reverse"/><xsl:param name="sort_name"/><xsl:param name="sort_dir"/><xsl:param name="sort_type"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_gids"><xsl:choose><xsl:when test="string-length($data_url) = 0"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:_collect_gids_without_data_gid"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="sort_name" select="$sort_name"/><xsl:with-param name="sort_dir" select="$sort_dir"/><xsl:with-param name="sort_type" select="$sort_type"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:call-template name="do:_collect_gids_with_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="sort_name" select="$sort_name"/><xsl:with-param name="sort_dir" select="$sort_dir"/><xsl:with-param name="sort_type" select="$sort_type"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:for-each select="document($data_url, /)"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:_collect_gids_without_data_gid"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="sort_name" select="$sort_name"/><xsl:with-param name="sort_dir" select="$sort_dir"/><xsl:with-param name="sort_type" select="$sort_type"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:call-template name="do:_collect_gids_with_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="sort_name" select="$sort_name"/><xsl:with-param name="sort_dir" select="$sort_dir"/><xsl:with-param name="sort_type" select="$sort_type"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:for-each></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_num_of_gids"><xsl:if test="$reverse = $ut:true"><xsl:variable name="_len0" select="string-length($_gids)"/><xsl:variable name="_len1" select="string-length(translate($_gids, $do:_object_sep, ''))"/><xsl:variable name="_sep_len" select="string-length($do:_object_sep)"/><xsl:value-of select="($_len0 - $_len1) div $_sep_len"/></xsl:if></xsl:variable><xsl:call-template name="do:_for_by_gids_rcr"><xsl:with-param name="gids" select="$_gids"/><xsl:with-param name="reverse" select="$reverse"/><xsl:with-param name="index">1</xsl:with-param><xsl:with-param name="index_set" select="$index_set"/><xsl:with-param name="index_id" select="$index_id"/><xsl:with-param name="count" select="$_num_of_gids"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:template><xsl:template name="do:_collect_gids_without_data_gid"><xsl:param name="expath"/><xsl:param name="sort_name"/><xsl:param name="sort_type"/><xsl:param name="sort_dir"/><xsl:variable name="_gids0"><xsl:call-template name="do:get_objects_by_expath"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what">id</xsl:with-param><xsl:with-param name="suffix" select="$do:_object_sep"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="string-length($sort_name) &gt; 0 or string-length($sort_dir) &gt; 0 or string-length($sort_type) &gt; 0"><xsl:call-template name="do:_sort_gids"><xsl:with-param name="gids" select="$_gids0"/><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="sort_name" select="$sort_name"/><xsl:with-param name="sort_dir" select="$sort_dir"/><xsl:with-param name="sort_type" select="$sort_type"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:value-of select="$_gids0"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_collect_gids_with_data_gid"><xsl:param name="data_gid"/><xsl:param name="expath"/><xsl:param name="sort_name"/><xsl:param name="sort_type"/><xsl:param name="sort_dir"/><xsl:variable name="_gids0"><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]"><xsl:call-template name="do:get_objects_by_expath"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what">id</xsl:with-param><xsl:with-param name="suffix" select="$do:_object_sep"/></xsl:call-template></xsl:for-each><xsl:for-each select="//*[generate-id() = $data_gid]"><xsl:call-template name="do:get_objects_by_expath"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what">id</xsl:with-param><xsl:with-param name="suffix" select="$do:_object_sep"/></xsl:call-template></xsl:for-each></xsl:variable><xsl:choose><xsl:when test="string-length($sort_name) &gt; 0 or string-length($sort_dir) &gt; 0 or string-length($sort_type) &gt; 0"><xsl:call-template name="do:_sort_gids"><xsl:with-param name="gids" select="$_gids0"/><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="sort_name" select="$sort_name"/><xsl:with-param name="sort_dir" select="$sort_dir"/><xsl:with-param name="sort_type" select="$sort_type"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:value-of select="$_gids0"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_for_by_gids_rcr"><xsl:param name="gids"/><xsl:param name="reverse"/><xsl:param name="index"/><xsl:param name="index_set"/><xsl:param name="index_id"/><xsl:param name="count"/><xsl:param name="allow"/><xsl:param name="allow_text_node"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:param name="data_url"/><xsl:variable name="_index_set"><xsl:if test="string-length($index_id) &gt; 0"><xsl:value-of select="$do:_object_sep"/><xsl:value-of select="$index_id"/><xsl:value-of select="$do:_cond_op_sep"/><xsl:choose><xsl:when test="$reverse = $ut:true"><xsl:value-of select="$count + 1 - $index"/></xsl:when><xsl:otherwise><xsl:value-of select="$index"/></xsl:otherwise></xsl:choose></xsl:if><xsl:choose><xsl:when test="string-length($index_set) = 0"><xsl:value-of select="$do:_object_sep"/></xsl:when><xsl:otherwise><xsl:value-of select="$index_set"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_gid" select="substring-before($gids, $do:_object_sep)"/><xsl:variable name="_next" select="substring-after($gids, $do:_object_sep)"/><xsl:choose><xsl:when test="$reverse = $ut:true"><xsl:if test="string-length($_next) &gt; 0"><xsl:call-template name="do:_for_by_gids_rcr"><xsl:with-param name="gids" select="$_next"/><xsl:with-param name="reverse" select="$reverse"/><xsl:with-param name="index" select="$index + 1"/><xsl:with-param name="index_set" select="$index_set"/><xsl:with-param name="index_id" select="$index_id"/><xsl:with-param name="count" select="$count"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:if><xsl:if test="string-length($_gid) &gt; 0"><xsl:call-template name="do:_apply_each_node"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$_gid"/><xsl:with-param name="data_index" select="$count + 1 - $index"/><xsl:with-param name="data_indexes" select="$_index_set"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:if></xsl:when><xsl:otherwise><xsl:if test="string-length($_gid) &gt; 0"><xsl:call-template name="do:_apply_each_node"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$_gid"/><xsl:with-param name="data_index" select="$index"/><xsl:with-param name="data_indexes" select="$_index_set"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:if><xsl:if test="string-length($_next) &gt; 0"><xsl:call-template name="do:_for_by_gids_rcr"><xsl:with-param name="gids" select="$_next"/><xsl:with-param name="reverse" select="$reverse"/><xsl:with-param name="index" select="$index + 1"/><xsl:with-param name="index_set" select="$index_set"/><xsl:with-param name="index_id" select="$index_id"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:if></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_apply_each_node"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:choose><xsl:when test="string-length($allow) = 0"><xsl:choose><xsl:when test="$allow_text_node = $ut:true"><xsl:apply-templates select="text()|*[not(contains($deny, concat('|', name(), '|')))]"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates select="*[not(contains($deny, concat('|', name(), '|')))]"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:choose><xsl:when test="$allow_text_node = $ut:true"><xsl:apply-templates select="text()|*[contains($allow, concat('|', name(), '|')) and not(contains($deny, concat('|', name(), '|')))]"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates select="*[contains($allow, concat('|', name(), '|')) and not(contains($deny, concat('|', name(), '|')))]"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_sort_gids"><xsl:param name="gids"/><xsl:param name="expath"/><xsl:param name="sort_name"/><xsl:param name="sort_dir"/><xsl:param name="sort_type"/><xsl:variable name="_last"><xsl:call-template name="do:_get_last_node_name"><xsl:with-param name="expath" select="$expath"/></xsl:call-template></xsl:variable><xsl:variable name="_is_last_attr"><xsl:if test="starts-with($_last, '@')"><xsl:value-of select="$ut:true"/></xsl:if></xsl:variable><xsl:variable name="_last_name"><xsl:choose><xsl:when test="$_is_last_attr = $ut:true"><xsl:value-of select="substring($_last, 2)"/></xsl:when><xsl:otherwise><xsl:value-of select="$_last"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_ns"><xsl:value-of select="substring-before($_last_name, $do:_ns_sep)"/></xsl:variable><xsl:variable name="_lname"><xsl:value-of select="substring-before(substring-after($_last_name, $do:_ns_sep), $do:_cond_sep)"/></xsl:variable><xsl:variable name="_is_sort_by_attr"><xsl:if test="starts-with($sort_name, '@')"><xsl:value-of select="$ut:true"/></xsl:if></xsl:variable><xsl:variable name="_sort_name"><xsl:choose><xsl:when test="$_is_sort_by_attr = $ut:true"><xsl:value-of select="substring($sort_name, 2)"/></xsl:when><xsl:otherwise><xsl:value-of select="$sort_name"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_sort_ns"><xsl:variable name="_s" select="substring-before($_sort_name, ':')"/><xsl:choose><xsl:when test="string-length($_s) &gt; 0"><xsl:call-template name="ut:get_namespace_uri"><xsl:with-param name="prefix" select="$_s"/></xsl:call-template></xsl:when></xsl:choose></xsl:variable><xsl:variable name="_sort_elem_lname"><xsl:variable name="_s" select="substring-after($_sort_name, ':')"/><xsl:choose><xsl:when test="string-length($_s) &gt; 0"><xsl:value-of select="$_s"/></xsl:when><xsl:otherwise><xsl:value-of select="$_sort_name"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_sort_lname"><xsl:variable name="_s" select="substring-before($_sort_elem_lname, '/@')"/><xsl:choose><xsl:when test="string-length($_s) &gt; 0"><xsl:value-of select="$_s"/></xsl:when><xsl:otherwise><xsl:value-of select="$_sort_elem_lname"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_sort_attr_name"><xsl:variable name="_s" select="substring-after($_sort_elem_lname, '/@')"/><xsl:choose><xsl:when test="string-length($_s) &gt; 0"><xsl:value-of select="$_s"/></xsl:when></xsl:choose></xsl:variable><xsl:variable name="_sort_attr_ns"><xsl:variable name="_s" select="substring-before($_sort_attr_name, ':')"/><xsl:choose><xsl:when test="string-length($_s) &gt; 0"><xsl:call-template name="ut:get_namespace_uri"><xsl:with-param name="prefix" select="$_s"/></xsl:call-template></xsl:when></xsl:choose></xsl:variable><xsl:variable name="_sort_attr_lname"><xsl:variable name="_s" select="substring-after($_sort_attr_name, ':')"/><xsl:choose><xsl:when test="string-length($_s) &gt; 0"><xsl:value-of select="$_s"/></xsl:when><xsl:otherwise><xsl:value-of select="$_sort_attr_name"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_sort_dir"><xsl:choose><xsl:when test="$sort_dir = 'desc'">descending</xsl:when><xsl:otherwise>ascending</xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_sort_type"><xsl:choose><xsl:when test="$sort_type = 'number'">number</xsl:when><xsl:otherwise>text</xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_sorted_gids"><xsl:choose><xsl:when test="$_is_last_attr = $ut:true"><xsl:if test="string-length($sort_name) = 0 or $sort_name='.'"><xsl:call-template name="do:_sort_attributes"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="ns" select="$_ns"/><xsl:with-param name="lname" select="$_lname"/><xsl:with-param name="sort_dir" select="$_sort_dir"/><xsl:with-param name="sort_type" select="$_sort_type"/></xsl:call-template></xsl:if></xsl:when><xsl:when test="$_is_sort_by_attr = $ut:true"><xsl:call-template name="do:_sort_elements_by_attribute"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="ns" select="$_ns"/><xsl:with-param name="lname" select="$_lname"/><xsl:with-param name="sort_ns" select="$_sort_ns"/><xsl:with-param name="sort_lname" select="$_sort_lname"/><xsl:with-param name="sort_dir" select="$_sort_dir"/><xsl:with-param name="sort_type" select="$_sort_type"/></xsl:call-template></xsl:when><xsl:when test="string-length($sort_name) = 0 or $sort_name = '.'"><xsl:call-template name="do:_sort_elements_without_sort_name"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="ns" select="$_ns"/><xsl:with-param name="lname" select="$_lname"/><xsl:with-param name="sort_dir" select="$_sort_dir"/><xsl:with-param name="sort_type" select="$_sort_type"/></xsl:call-template></xsl:when><xsl:when test="string-length($_sort_attr_name) &gt; 0"><xsl:call-template name="do:_sort_elements_by_element_and_attribute"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="ns" select="$_ns"/><xsl:with-param name="lname" select="$_lname"/><xsl:with-param name="sort_ns" select="$_sort_ns"/><xsl:with-param name="sort_lname" select="$_sort_lname"/><xsl:with-param name="sort_attr_ns" select="$_sort_attr_ns"/><xsl:with-param name="sort_attr_lname" select="$_sort_attr_lname"/><xsl:with-param name="sort_dir" select="$_sort_dir"/><xsl:with-param name="sort_type" select="$_sort_type"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:call-template name="do:_sort_elements_by_element"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="ns" select="$_ns"/><xsl:with-param name="lname" select="$_lname"/><xsl:with-param name="sort_ns" select="$_sort_ns"/><xsl:with-param name="sort_lname" select="$_sort_lname"/><xsl:with-param name="sort_dir" select="$_sort_dir"/><xsl:with-param name="sort_type" select="$_sort_type"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:variable><xsl:call-template name="do:_sort_selected_gids_rcr"><xsl:with-param name="selected_gids" select="concat($do:_object_sep, $gids)"/><xsl:with-param name="sorted_gids" select="$_sorted_gids"/></xsl:call-template></xsl:template><xsl:template name="do:_sort_attributes"><xsl:param name="expath"/><xsl:param name="ns"/><xsl:param name="lname"/><xsl:param name="sort_dir"/><xsl:param name="sort_type"/><xsl:choose><xsl:when test="starts-with($expath, $do:_path_sep)"><xsl:for-each select="//attribute::node()[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select=".//attribute::node()[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_sort_elements_by_attribute"><xsl:param name="expath"/><xsl:param name="ns"/><xsl:param name="lname"/><xsl:param name="sort_ns"/><xsl:param name="sort_lname"/><xsl:param name="sort_dir"/><xsl:param name="sort_type"/><xsl:choose><xsl:when test="starts-with($expath, $do:_path_sep)"><xsl:for-each select="/descendant::*[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort select="attribute::node()[namespace-uri() = $sort_ns and local-name() = $sort_lname]" order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select="descendant::*[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort select="attribute::node()[namespace-uri() = $sort_ns and local-name() = $sort_lname]" order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_sort_elements_by_element"><xsl:param name="expath"/><xsl:param name="ns"/><xsl:param name="lname"/><xsl:param name="sort_ns"/><xsl:param name="sort_lname"/><xsl:param name="sort_dir"/><xsl:param name="sort_type"/><xsl:choose><xsl:when test="starts-with($expath, $do:_path_sep)"><xsl:for-each select="/descendant::*[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort select="*[namespace-uri() = $sort_ns and local-name() = $sort_lname]" order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select="descendant::*[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort select="*[namespace-uri() = $sort_ns and local-name() = $sort_lname]" order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_sort_elements_by_element_and_attribute"><xsl:param name="expath"/><xsl:param name="ns"/><xsl:param name="lname"/><xsl:param name="sort_ns"/><xsl:param name="sort_lname"/><xsl:param name="sort_attr_ns"/><xsl:param name="sort_attr_lname"/><xsl:param name="sort_dir"/><xsl:param name="sort_type"/><xsl:choose><xsl:when test="starts-with($expath, $do:_path_sep)"><xsl:for-each select="/descendant::*[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort select="*[namespace-uri() = $sort_ns and local-name() = $sort_lname]/attribute::node()[namespace-uri() = $sort_attr_ns and local-name() = $sort_attr_lname]" order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select="descendant::*[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort select="*[namespace-uri() = $sort_ns and local-name() = $sort_lname]/attribute::node()[namespace-uri() = $sort_attr_ns and local-name() = $sort_attr_lname]" order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_sort_elements_without_sort_name"><xsl:param name="expath"/><xsl:param name="ns"/><xsl:param name="lname"/><xsl:param name="sort_dir"/><xsl:param name="sort_type"/><xsl:choose><xsl:when test="starts-with($expath, $do:_path_sep)"><xsl:for-each select="/descendant::*[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select="descendant::*[namespace-uri() = $ns and local-name() = $lname]"><xsl:sort order="{$sort_dir}" data-type="{$sort_type}"/><xsl:value-of select="generate-id()"/><xsl:value-of select="$do:_object_sep"/></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_get_last_node_name"><xsl:param name="expath"/><xsl:variable name="_next" select="substring-after($expath, $do:_path_sep)"/><xsl:choose><xsl:when test="string-length($_next) &gt; 0"><xsl:call-template name="do:_get_last_node_name"><xsl:with-param name="expath" select="$_next"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:value-of select="$expath"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_sort_selected_gids_rcr"><xsl:param name="selected_gids"/><xsl:param name="sorted_gids"/><xsl:variable name="_gid" select="substring-before($sorted_gids, $do:_object_sep)"/><xsl:variable name="_next" select="substring-after($sorted_gids, $do:_object_sep)"/><xsl:if test="string-length($_gid) &gt; 0"><xsl:if test="contains($selected_gids, concat($do:_object_sep, $_gid, $do:_object_sep))"><xsl:value-of select="$_gid"/><xsl:value-of select="$do:_object_sep"/></xsl:if><xsl:call-template name="do:_sort_selected_gids_rcr"><xsl:with-param name="selected_gids" select="$selected_gids"/><xsl:with-param name="sorted_gids" select="$_next"/></xsl:call-template></xsl:if></xsl:template><xsl:template name="do:match_condition_by_path"><xsl:param name="condition"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:variable name="_cond_by_expath"><xsl:call-template name="do:expand_path_in_condition"><xsl:with-param name="condition" select="$condition"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="string-length($data_url) = 0"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:match_condition_by_expath"><xsl:with-param name="condition" select="$_cond_by_expath"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]"><xsl:call-template name="do:match_condition_by_expath"><xsl:with-param name="condition" select="$_cond_by_expath"/></xsl:call-template></xsl:for-each><xsl:for-each select="//*[generate-id() = $data_gid]"><xsl:call-template name="do:match_condition_by_expath"><xsl:with-param name="condition" select="$_cond_by_expath"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:for-each select="document($data_url, /)"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:match_condition_by_expath"><xsl:with-param name="condition" select="$_cond_by_expath"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]"><xsl:call-template name="do:match_condition_by_expath"><xsl:with-param name="condition" select="$_cond_by_expath"/></xsl:call-template></xsl:for-each><xsl:for-each select="//*[generate-id() = $data_gid]"><xsl:call-template name="do:match_condition_by_expath"><xsl:with-param name="condition" select="$_cond_by_expath"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:for_times"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="times"/><xsl:param name="index_set"/><xsl:param name="index_id"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:call-template name="do:_for_times_rcr"><xsl:with-param name="times" select="$times"/><xsl:with-param name="index">1</xsl:with-param><xsl:with-param name="index_set" select="$index_set"/><xsl:with-param name="index_id" select="$index_id"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:template><xsl:template name="do:_for_times_rcr"><xsl:param name="times"/><xsl:param name="index"/><xsl:param name="index_set"/><xsl:param name="index_id"/><xsl:param name="allow"/><xsl:param name="allow_text_node"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:variable name="_index_set"><xsl:if test="string-length($index_id) &gt; 0"><xsl:value-of select="$do:_object_sep"/><xsl:value-of select="$index_id"/><xsl:value-of select="$do:_cond_op_sep"/><xsl:value-of select="$index"/></xsl:if><xsl:choose><xsl:when test="string-length($index_set) = 0"><xsl:value-of select="$do:_object_sep"/></xsl:when><xsl:otherwise><xsl:value-of select="$index_set"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:if test="$index &lt;= $times"><xsl:call-template name="do:_apply_each_node"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$index"/><xsl:with-param name="data_indexes" select="$_index_set"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template><xsl:call-template name="do:_for_times_rcr"><xsl:with-param name="times" select="$times"/><xsl:with-param name="index" select="$index + 1"/><xsl:with-param name="index_set" select="$index_set"/><xsl:with-param name="index_id" select="$index_id"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="$deny"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:if></xsl:template><xsl:template name="do:operate_expression"><xsl:param name="left"/><xsl:param name="op"/><xsl:param name="right"/><xsl:choose><xsl:when test="$op = 'eq'"><xsl:if test="$left = $right"><xsl:value-of select="$ut:true"/></xsl:if></xsl:when><xsl:when test="$op = 'ne'"><xsl:if test="$left != $right"><xsl:value-of select="$ut:true"/></xsl:if></xsl:when><xsl:when test="$op = 'lt'"><xsl:if test="$left &lt; $right"><xsl:value-of select="$ut:true"/></xsl:if></xsl:when><xsl:when test="$op = 'le'"><xsl:if test="$left &lt;= $right"><xsl:value-of select="$ut:true"/></xsl:if></xsl:when><xsl:when test="$op = 'gt'"><xsl:if test="$left &gt; $right"><xsl:value-of select="$ut:true"/></xsl:if></xsl:when><xsl:when test="$op = 'ge'"><xsl:if test="$left &gt;= $right"><xsl:value-of select="$ut:true"/></xsl:if></xsl:when></xsl:choose></xsl:template><xsl:template name="do:get_objects_by_path"><xsl:param name="path"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:variable name="_expath"><xsl:call-template name="do:expand_path"><xsl:with-param name="path" select="$path"/></xsl:call-template></xsl:variable><xsl:call-template name="do:get_objects_by_expath"><xsl:with-param name="expath" select="$_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:template><xsl:template name="do:get_objects_by_expath"><xsl:param name="expath"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:choose><xsl:when test="string-length($data_url) = 0"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:_get_objects_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]"><xsl:call-template name="do:_get_objects_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each><xsl:for-each select="//*[generate-id() = $data_gid]"><xsl:call-template name="do:_get_objects_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:for-each select="document($data_url, /)"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:_get_objects_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]"><xsl:call-template name="do:_get_objects_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each><xsl:for-each select="//*[generate-id() = $data_gid]"><xsl:call-template name="do:_get_objects_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_get_objects_by_expath_from_current_node"><xsl:param name="expath"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="path_sep" select="$do:_path_sep"/><xsl:choose><xsl:when test="starts-with($expath, $path_sep)"><xsl:for-each select="/"><xsl:variable name="_next" select="substring-after($expath, $path_sep)"/><xsl:call-template name="do:_get_objects_by_expath_rcr"><xsl:with-param name="expath" select="$_next"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:for-each></xsl:when><xsl:otherwise><xsl:call-template name="do:_get_objects_by_expath_rcr"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_get_objects_by_expath_rcr"><xsl:param name="expath"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="path_sep"/><xsl:choose><xsl:when test="$expath = ''"><xsl:choose><xsl:when test="boolean(../attribute::node() = current())"><xsl:call-template name="do:get_current_attribute"><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:call-template name="do:get_current_value"><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:variable name="_nd0" select="substring-before($expath, $path_sep)"/><xsl:variable name="_next" select="substring-after($expath, $path_sep)"/><xsl:variable name="_at"><xsl:if test="starts-with($_nd0, '@')"><xsl:value-of select="$ut:true"/></xsl:if></xsl:variable><xsl:variable name="_nd1"><xsl:choose><xsl:when test="$_at = $ut:true"><xsl:value-of select="substring($_nd0, 2)"/></xsl:when><xsl:otherwise><xsl:value-of select="$_nd0"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_ns" select="substring-before($_nd1, $do:_ns_sep)"/><xsl:variable name="_nd2" select="substring-after($_nd1, $do:_ns_sep)"/><xsl:variable name="_lnm" select="substring-before($_nd2, $do:_cond_sep)"/><xsl:variable name="_cnd" select="substring-after($_nd2, $do:_cond_sep)"/><xsl:call-template name="do:_resolve_namespace_and_localname"><xsl:with-param name="is_attr" select="$_at"/><xsl:with-param name="namespace" select="$_ns"/><xsl:with-param name="localname" select="$_lnm"/><xsl:with-param name="condition" select="$_cnd"/><xsl:with-param name="next_expath" select="$_next"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_resolve_namespace_and_localname"><xsl:param name="is_attr"/><xsl:param name="namespace"/><xsl:param name="localname"/><xsl:param name="condition"/><xsl:param name="next_expath"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="path_sep"/><xsl:choose><xsl:when test="$is_attr = $ut:true"><xsl:if test="string-length($next_expath) = 0"><xsl:for-each select="attribute::node()[$namespace = namespace-uri() and $localname = local-name()]"><xsl:call-template name="do:_get_conditional_attribute"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each></xsl:if></xsl:when><xsl:when test="$localname = '*'"><xsl:choose><xsl:when test="string-length($namespace) = 0"><xsl:for-each select="*"><xsl:call-template name="do:_get_conditional_object"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select="*[namespace-uri() = $namespace]"><xsl:call-template name="do:_get_conditional_object"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:when><xsl:when test="$localname = '**'"><xsl:choose><xsl:when test="string-length($namespace) = 0"><xsl:for-each select="descendant-or-self::node()"><xsl:call-template name="do:_get_conditional_object"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select="descendant-or-self::node()[namespace-uri() = $namespace]"><xsl:call-template name="do:_get_conditional_object"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:when><xsl:when test="$localname = '.'"><xsl:call-template name="do:_get_conditional_object"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:when><xsl:when test="$localname = '..'"><xsl:choose><xsl:when test="string-length($namespace) = 0"><xsl:for-each select="parent::*"><xsl:call-template name="do:_get_conditional_object"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select="parent::*[namespace-uri() = $namespace]"><xsl:call-template name="do:_get_conditional_object"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:for-each select="*[namespace-uri() = $namespace and local-name() = $localname]"><xsl:call-template name="do:_get_conditional_object"><xsl:with-param name="condition" select="$condition"/><xsl:with-param name="next_expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:get_current_value"><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:value-of select="$prefix"/><xsl:choose><xsl:when test="$what = 'content'"><xsl:variable name="_content"><xsl:apply-templates/></xsl:variable><xsl:value-of select="normalize-space($_content)"/></xsl:when><xsl:when test="$what = 'text'"><xsl:value-of select="normalize-space(text())"/></xsl:when><xsl:when test="$what = 'number'"><xsl:value-of select="number(text())"/></xsl:when><xsl:when test="$what = 'name'"><xsl:value-of select="local-name()"/></xsl:when><xsl:when test="$what = 'id'"><xsl:value-of select="generate-id()"/></xsl:when><xsl:when test="$what = 'preceding-comment'"><xsl:call-template name="do:_get_preceding_comment"/></xsl:when><xsl:when test="$what = 'following-comment'"><xsl:call-template name="do:_get_following_comment"/></xsl:when></xsl:choose><xsl:value-of select="$suffix"/></xsl:template><xsl:template name="do:_get_preceding_comment"><xsl:variable name="_nid1" select="generate-id(preceding-sibling::node()[1])"/><xsl:variable name="_cid1" select="generate-id(preceding-sibling::comment()[1])"/><xsl:choose><xsl:when test="$_nid1 = $_cid1"><xsl:value-of select="preceding-sibling::comment()[1]"/></xsl:when><xsl:otherwise><xsl:variable name="_tid1" select="generate-id(preceding-sibling::text()[1])"/><xsl:if test="$_nid1 = $_tid1"><xsl:if test="string-length(normalize-space(preceding-sibling::text()[1])) = 0"><xsl:variable name="_nid2" select="generate-id(preceding-sibling::node()[2])"/><xsl:if test="$_nid2 = $_cid1"><xsl:value-of select="preceding-sibling::comment()[1]"/></xsl:if></xsl:if></xsl:if></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_get_following_comment"><xsl:variable name="_nid1" select="generate-id(following-sibling::node()[1])"/><xsl:variable name="_cid1" select="generate-id(following-sibling::comment()[1])"/><xsl:choose><xsl:when test="$_nid1 = $_cid1"><xsl:value-of select="following-sibling::comment()[1]"/></xsl:when><xsl:otherwise><xsl:variable name="_tid1" select="generate-id(following-sibling::text()[1])"/><xsl:if test="$_nid1 = $_tid1"><xsl:if test="string-length(normalize-space(following-sibling::text()[1])) = 0"><xsl:variable name="_nid2" select="generate-id(following-sibling::node()[2])"/><xsl:if test="$_nid2 = $_cid1"><xsl:value-of select="following-sibling::comment()[1]"/></xsl:if></xsl:if></xsl:if></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:get_current_attribute"><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:value-of select="$prefix"/><xsl:choose><xsl:when test="$what = 'content'"><xsl:value-of select="."/></xsl:when><xsl:when test="$what = 'text'"><xsl:value-of select="."/></xsl:when><xsl:when test="$what = 'number'"><xsl:value-of select="number()"/></xsl:when><xsl:when test="$what = 'name'"><xsl:value-of select="local-name()"/></xsl:when><xsl:when test="$what = 'id'"><xsl:value-of select="generate-id()"/></xsl:when></xsl:choose><xsl:value-of select="$suffix"/></xsl:template><xsl:template name="do:_get_conditional_attribute"><xsl:param name="condition"/><xsl:param name="next_expath"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:variable name="_matched"><xsl:call-template name="do:match_condition_by_expath"><xsl:with-param name="condition" select="$condition"/></xsl:call-template></xsl:variable><xsl:if test="$_matched = $ut:true and string-length($next_expath) = 0"><xsl:call-template name="do:get_current_attribute"><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:if></xsl:template><xsl:template name="do:_get_conditional_object"><xsl:param name="condition"/><xsl:param name="next_expath"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="path_sep"/><xsl:variable name="_matched"><xsl:call-template name="do:match_condition_by_expath"><xsl:with-param name="condition" select="$condition"/></xsl:call-template></xsl:variable><xsl:if test="$_matched = $ut:true"><xsl:call-template name="do:_get_objects_by_expath_rcr"><xsl:with-param name="expath" select="$next_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:if></xsl:template><xsl:template name="do:match_condition_by_expath"><xsl:param name="condition"/><xsl:variable name="_cond0"><xsl:call-template name="ut:trim"><xsl:with-param name="string" select="$condition"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="string-length($_cond0) = 0"><xsl:value-of select="$ut:true"/></xsl:when><xsl:otherwise><xsl:variable name="_pos" select="number($_cond0)"/><xsl:choose><xsl:when test="boolean($_pos)"><xsl:if test="$_pos = position()"><xsl:value-of select="$ut:true"/></xsl:if></xsl:when><xsl:otherwise><xsl:call-template name="do:_match_conditions_or"><xsl:with-param name="conds" select="$_cond0"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_match_conditions_or"><xsl:param name="conds"/><xsl:choose><xsl:when test="string-length($conds) = 0"/><xsl:otherwise><xsl:variable name="_cond" select="substring-before($conds, $do:_cond_or_sep)"/><xsl:variable name="_matched"><xsl:call-template name="do:_match_conditions_and"><xsl:with-param name="conds" select="$_cond"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="$_matched = $ut:true"><xsl:value-of select="$ut:true"/></xsl:when><xsl:otherwise><xsl:variable name="_next" select="substring-after($conds, $do:_cond_or_sep)"/><xsl:call-template name="do:_match_conditions_or"><xsl:with-param name="conds" select="$_next"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_match_conditions_and"><xsl:param name="conds"/><xsl:choose><xsl:when test="string-length($conds) = 0"/><xsl:otherwise><xsl:variable name="_cond" select="substring-before($conds, $do:_cond_and_sep)"/><xsl:variable name="_matched"><xsl:call-template name="do:_match_single_condition"><xsl:with-param name="cond" select="$_cond"/></xsl:call-template></xsl:variable><xsl:if test="$_matched = $ut:true"><xsl:variable name="_next" select="substring-after($conds, $do:_cond_and_sep)"/><xsl:choose><xsl:when test="string-length($_next) = 0"><xsl:value-of select="$ut:true"/></xsl:when><xsl:otherwise><xsl:call-template name="do:_match_conditions_and"><xsl:with-param name="conds" select="$_next"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:if></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_match_single_condition"><xsl:param name="cond"/><xsl:variable name="_after" select="substring-after($cond, $do:_cond_op_sep)"/><xsl:variable name="_op" select="substring-before($_after, $do:_cond_op_sep)"/><xsl:variable name="_right"><xsl:variable name="_r0" select="substring-after($_after, $do:_cond_op_sep)"/><xsl:call-template name="ut:trim_start"><xsl:with-param name="string" select="$_r0"/></xsl:call-template></xsl:variable><xsl:variable name="_quote"><xsl:if test="string(number($_right)) = 'NaN'"><xsl:value-of select="$ut:apos"/></xsl:if></xsl:variable><xsl:variable name="_left"><xsl:variable name="_e0" select="substring-before($cond, $do:_cond_op_sep)"/><xsl:variable name="_e1"><xsl:call-template name="ut:trim_end"><xsl:with-param name="string" select="$_e0"/></xsl:call-template></xsl:variable><xsl:variable name="_e2"><xsl:call-template name="do:_get_objects_by_expath_from_current_node"><xsl:with-param name="expath" select="$_e1"/><xsl:with-param name="what">content</xsl:with-param><xsl:with-param name="prefix" select="$_quote"/><xsl:with-param name="suffix" select="concat($_quote, $do:_object_sep)"/><xsl:with-param name="path_sep" select="$do:_cond_path_sep"/></xsl:call-template></xsl:variable><xsl:variable name="_e3" select="substring-before($_e2, $do:_object_sep)"/><xsl:call-template name="ut:trim"><xsl:with-param name="string" select="$_e3"/></xsl:call-template></xsl:variable><xsl:call-template name="do:operate_expression"><xsl:with-param name="left" select="$_left"/><xsl:with-param name="op" select="$_op"/><xsl:with-param name="right" select="$_right"/></xsl:call-template></xsl:template><xsl:template name="do:first_object_by_path"><xsl:param name="path"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:variable name="_expath"><xsl:call-template name="do:expand_path"><xsl:with-param name="path" select="$path"/></xsl:call-template></xsl:variable><xsl:call-template name="do:first_object_by_expath"><xsl:with-param name="expath" select="$_expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:template><xsl:template name="do:first_object_by_expath"><xsl:param name="expath"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:choose><xsl:when test="string-length($data_url) = 0"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:_first_object_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]|//*[generate-id() = $data_gid]"><xsl:call-template name="do:_first_object_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:for-each select="document($data_url, /)"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:_first_object_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]|//*[generate-id() = $data_gid]"><xsl:call-template name="do:_first_object_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_first_object_by_expath_from_current_node"><xsl:param name="expath"/><xsl:param name="what"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:variable name="_gids"><xsl:call-template name="do:get_objects_by_expath"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="what">id</xsl:with-param><xsl:with-param name="suffix" select="$do:_object_sep"/></xsl:call-template></xsl:variable><xsl:variable name="_gid" select="normalize-space(substring-before($_gids, $do:_object_sep))"/><xsl:for-each select="//attribute::node()[generate-id() = $_gid]"><xsl:call-template name="do:get_current_attribute"><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each><xsl:for-each select="//*[generate-id() = $_gid]"><xsl:call-template name="do:get_current_value"><xsl:with-param name="what" select="$what"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each></xsl:template><xsl:template name="do:count_nodes_by_path"><xsl:param name="path"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:variable name="_expath"><xsl:call-template name="do:expand_path"><xsl:with-param name="path" select="$path"/></xsl:call-template></xsl:variable><xsl:call-template name="do:count_nodes_by_expath"><xsl:with-param name="expath" select="$_expath"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:template><xsl:template name="do:count_nodes_by_expath"><xsl:param name="expath"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:choose><xsl:when test="string-length($data_url) = 0"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:_count_nodes_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]|//*[generate-id() = $data_gid]"><xsl:call-template name="do:_count_nodes_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:for-each select="document($data_url, /)"><xsl:choose><xsl:when test="string-length($data_gid) = 0"><xsl:call-template name="do:_count_nodes_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select="//attribute::node()[generate-id() = $data_gid]|//*[generate-id() = $data_gid]"><xsl:call-template name="do:_count_nodes_by_expath_from_current_node"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="prefix" select="$prefix"/><xsl:with-param name="suffix" select="$suffix"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_count_nodes_by_expath_from_current_node"><xsl:param name="expath"/><xsl:param name="prefix"/><xsl:param name="suffix"/><xsl:variable name="_flags"><xsl:call-template name="do:get_objects_by_expath"><xsl:with-param name="expath" select="$expath"/><xsl:with-param name="suffix">I</xsl:with-param></xsl:call-template></xsl:variable><xsl:value-of select="$prefix"/><xsl:value-of select="string-length($_flags)"/><xsl:value-of select="$suffix"/></xsl:template><xsl:template name="do:expand_path"><xsl:param name="path"/><xsl:param name="path_sep" select="$do:_path_sep"/><xsl:choose><xsl:when test="substring($path, 1, 1) = '/'"><xsl:value-of select="$path_sep"/><xsl:call-template name="do:_expand_path_rcr"><xsl:with-param name="path" select="substring($path, 2)"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:call-template name="do:_expand_path_rcr"><xsl:with-param name="path" select="$path"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_expand_path_rcr"><xsl:param name="path"/><xsl:param name="path_sep"/><xsl:choose><xsl:when test="string-length($path) = 0"/><xsl:when test="starts-with($path, '/')"><xsl:variable name="_next" select="substring($path, 2)"/><xsl:choose><xsl:when test="string-length($_next) = 0"/><xsl:otherwise><xsl:call-template name="do:_format_node"><xsl:with-param name="localname">**</xsl:with-param><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template><xsl:call-template name="do:_expand_path_rcr"><xsl:with-param name="path" select="$_next"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:when><xsl:otherwise><xsl:variable name="_first"><xsl:call-template name="do:_get_first_node"><xsl:with-param name="path" select="$path"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:variable><xsl:call-template name="do:_expand_first_node"><xsl:with-param name="name" select="$_first"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template><xsl:if test="string-length($_first) != 0"><xsl:variable name="_len" select="string-length($_first)"/><xsl:variable name="_next" select="substring($path, $_len + 2)"/><xsl:call-template name="do:_expand_path_rcr"><xsl:with-param name="path" select="$_next"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:if></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_format_node"><xsl:param name="attr_mark"/><xsl:param name="namespace"/><xsl:param name="localname"/><xsl:param name="condition"/><xsl:param name="path_sep"/><xsl:value-of select="$attr_mark"/><xsl:value-of select="$namespace"/><xsl:value-of select="$do:_ns_sep"/><xsl:value-of select="$localname"/><xsl:value-of select="$do:_cond_sep"/><xsl:value-of select="$condition"/><xsl:value-of select="$path_sep"/></xsl:template><xsl:template name="do:_get_first_node"><xsl:param name="path"/><xsl:param name="path_sep"/><xsl:variable name="_str0" select="substring-before($path, '/')"/><xsl:variable name="_len0" select="string-length($_str0)"/><xsl:choose><xsl:when test="$_len0 = 0"><xsl:value-of select="$path"/></xsl:when><xsl:otherwise><xsl:variable name="_str1" select="substring-after($_str0, '[')"/><xsl:variable name="_len1" select="string-length($_str1)"/><xsl:choose><xsl:when test="$_len1 = 0 and substring($_str0, $_len0) != '['"><xsl:value-of select="$_str0"/></xsl:when><xsl:when test="contains($_str1, ']')"><xsl:value-of select="$_str0"/></xsl:when><xsl:otherwise><xsl:variable name="_str2" select="substring($path, $_len0 + 1)"/><xsl:variable name="_str3" select="substring-before($_str2, ']')"/><xsl:variable name="_len3" select="string-length($_str3)"/><xsl:choose><xsl:when test="$_len3 = 0"><xsl:value-of select="$path"/></xsl:when><xsl:otherwise><xsl:variable name="_str4" select="substring($_str2, $_len3 + 1)"/><xsl:variable name="_str5" select="substring-before($_str4, '/')"/><xsl:variable name="_len5" select="string-length($_str5)"/><xsl:choose><xsl:when test="$_len5 = 0"><xsl:value-of select="$path"/></xsl:when><xsl:otherwise><xsl:variable name="_len" select="$_len0 + $_len3 + $_len5"/><xsl:value-of select="substring($path, 1, $_len)"/></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_expand_first_node"><xsl:param name="name"/><xsl:param name="path_sep"/><xsl:variable name="_at"><xsl:if test="starts-with($name, '@')">@</xsl:if></xsl:variable><xsl:variable name="_str0"><xsl:choose><xsl:when test="string-length($_at) = 0"><xsl:value-of select="$name"/></xsl:when><xsl:otherwise><xsl:value-of select="substring($name, 2)"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_str1" select="substring-before($_str0, '[')"/><xsl:variable name="_len1" select="string-length($_str1)"/><xsl:variable name="_str2"><xsl:choose><xsl:when test="$_len1 = 0"><xsl:value-of select="$_str0"/></xsl:when><xsl:otherwise><xsl:value-of select="$_str1"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_prefix" select="substring-before($_str2, ':')"/><xsl:variable name="_ns"><xsl:call-template name="ut:get_namespace_uri"><xsl:with-param name="prefix" select="$_prefix"/></xsl:call-template></xsl:variable><xsl:variable name="_lname"><xsl:choose><xsl:when test="string-length($_prefix) = 0"><xsl:value-of select="$_str2"/></xsl:when><xsl:otherwise><xsl:value-of select="substring($_str2, string-length($_prefix) + 2)"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_cond"><xsl:variable name="_str3" select="substring($_str0, $_len1 + 2)"/><xsl:variable name="_len3" select="string-length($_str3)"/><xsl:choose><xsl:when test="substring($_str3, $_len3) = ']'"><xsl:value-of select="substring($_str3, 1, $_len3 - 1)"/></xsl:when><xsl:otherwise><xsl:value-of select="substring-before($_str3, ']')"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_expanded_cond"><xsl:call-template name="do:expand_path_in_condition"><xsl:with-param name="condition" select="$_cond"/></xsl:call-template></xsl:variable><xsl:call-template name="do:_format_node"><xsl:with-param name="attr_mark" select="$_at"/><xsl:with-param name="namespace" select="$_ns"/><xsl:with-param name="localname" select="$_lname"/><xsl:with-param name="condition" select="$_expanded_cond"/><xsl:with-param name="path_sep" select="$path_sep"/></xsl:call-template></xsl:template><xsl:template name="do:expand_path_in_condition"><xsl:param name="condition"/><xsl:variable name="_cond0"><xsl:call-template name="ut:trim"><xsl:with-param name="string" select="$condition"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="string-length($_cond0) = 0"/><xsl:otherwise><xsl:variable name="_pos" select="number($_cond0)"/><xsl:choose><xsl:when test="boolean($_pos)"><xsl:value-of select="$_pos"/></xsl:when><xsl:otherwise><xsl:call-template name="do:_expand_path_in_or_condition"><xsl:with-param name="conds" select="$_cond0"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_expand_path_in_or_condition"><xsl:param name="conds"/><xsl:choose><xsl:when test="string-length($conds) = 0 or $conds = '|'"/><xsl:otherwise><xsl:variable name="_cond0"><xsl:call-template name="ut:trim_end"><xsl:with-param name="string" select="substring-before($conds, '|')"/></xsl:call-template></xsl:variable><xsl:variable name="_next0"><xsl:call-template name="ut:trim_start"><xsl:with-param name="string" select="substring-after($conds, '|')"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="string-length($_cond0) = 0 and string-length($_next0) = 0"><xsl:variable name="_cond1"><xsl:call-template name="do:_expand_path_in_and_condition"><xsl:with-param name="conds" select="$conds"/></xsl:call-template></xsl:variable><xsl:if test="string-length($_cond1) != 0"><xsl:value-of select="$_cond1"/><xsl:value-of select="$do:_cond_or_sep"/></xsl:if></xsl:when><xsl:otherwise><xsl:variable name="_cond1"><xsl:call-template name="do:_expand_path_in_and_condition"><xsl:with-param name="conds" select="$_cond0"/></xsl:call-template></xsl:variable><xsl:if test="string-length($_cond1) != 0"><xsl:value-of select="$_cond1"/><xsl:value-of select="$do:_cond_or_sep"/></xsl:if><xsl:call-template name="do:_expand_path_in_or_condition"><xsl:with-param name="conds" select="$_next0"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_expand_path_in_and_condition"><xsl:param name="conds"/><xsl:choose><xsl:when test="string-length($conds) = 0 or $conds = ','"/><xsl:otherwise><xsl:variable name="_cond0"><xsl:call-template name="ut:trim_end"><xsl:with-param name="string" select="substring-before($conds, ',')"/></xsl:call-template></xsl:variable><xsl:variable name="_next0"><xsl:call-template name="ut:trim_start"><xsl:with-param name="string" select="substring-after($conds, ',')"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="string-length($_cond0) =0 and string-length($_next0) =0"><xsl:variable name="_cond1"><xsl:call-template name="do:_expand_path_in_single_condition"><xsl:with-param name="expr" select="$conds"/></xsl:call-template></xsl:variable><xsl:if test="string-length($_cond1) != 0"><xsl:value-of select="$_cond1"/><xsl:value-of select="$do:_cond_and_sep"/></xsl:if></xsl:when><xsl:otherwise><xsl:variable name="_cond1"><xsl:call-template name="do:_expand_path_in_single_condition"><xsl:with-param name="expr" select="$_cond0"/></xsl:call-template></xsl:variable><xsl:if test="string-length($_cond1) != 0"><xsl:value-of select="$_cond1"/><xsl:value-of select="$do:_cond_and_sep"/></xsl:if><xsl:call-template name="do:_expand_path_in_and_condition"><xsl:with-param name="conds" select="$_next0"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="do:_expand_path_in_single_condition"><xsl:param name="expr"/><xsl:call-template name="do:_expand_path_in_single_condition_by_op"><xsl:with-param name="expr" select="$expr"/><xsl:with-param name="op_mark"><xsl:choose><xsl:when test="contains($expr, '!=')">!=</xsl:when><xsl:when test="contains($expr, '=')">=</xsl:when><xsl:when test="contains($expr, ' eq ')"> eq </xsl:when><xsl:when test="contains($expr, ' ne ')"> ne </xsl:when><xsl:when test="contains($expr, ' gt ')"> gt </xsl:when><xsl:when test="contains($expr, ' ge ')"> ge </xsl:when><xsl:when test="contains($expr, ' lt ')"> lt </xsl:when><xsl:when test="contains($expr, ' le ')"> le </xsl:when></xsl:choose></xsl:with-param><xsl:with-param name="op"><xsl:choose><xsl:when test="contains($expr, '!=')">ne</xsl:when><xsl:when test="contains($expr, '=')">eq</xsl:when><xsl:when test="contains($expr, ' eq ')">eq</xsl:when><xsl:when test="contains($expr, ' ne ')">ne</xsl:when><xsl:when test="contains($expr, ' gt ')">gt</xsl:when><xsl:when test="contains($expr, ' ge ')">ge</xsl:when><xsl:when test="contains($expr, ' lt ')">lt</xsl:when><xsl:when test="contains($expr, ' le ')">le</xsl:when></xsl:choose></xsl:with-param></xsl:call-template></xsl:template><xsl:template name="do:_expand_path_in_single_condition_by_op"><xsl:param name="expr"/><xsl:param name="op_mark"/><xsl:param name="op"/><xsl:variable name="_path"><xsl:call-template name="ut:trim_end"><xsl:with-param name="string" select="substring-before($expr, $op_mark)"/></xsl:call-template></xsl:variable><xsl:call-template name="do:expand_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="path_sep" select="$do:_cond_path_sep"/></xsl:call-template><xsl:value-of select="$do:_cond_op_sep"/><xsl:value-of select="$op"/><xsl:value-of select="$do:_cond_op_sep"/><xsl:call-template name="ut:trim_start"><xsl:with-param name="string" select="substring-after($expr, $op_mark)"/></xsl:call-template></xsl:template><xsl:template match="count"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:count_nodes_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:template><xsl:template match="for[boolean(@each) or boolean(attr/@name='each')]"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">each</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_index_id"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">index</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_reverse"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">reverse</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_sort_name"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">sort-by</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_sort_dir"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">sort-dir</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_sort_type"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">sort-type</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:for_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="index_id" select="$_index_id"/><xsl:with-param name="index_set" select="$data_indexes"/><xsl:with-param name="reverse" select="$_reverse"/><xsl:with-param name="sort_name" select="$_sort_name"/><xsl:with-param name="sort_dir" select="$_sort_dir"/><xsl:with-param name="sort_type" select="$_sort_type"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny">|attr|</xsl:with-param><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:template><xsl:template match="preceding-comment"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">preceding-comment</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:template><xsl:template match="following-comment"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">following-comment</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:template><xsl:template name="book:get_attr"><xsl:param name="name"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="@*[name()=$name]"><xsl:value-of select="@*[name()=$name]"/></xsl:when><xsl:otherwise><xsl:for-each select="attr[@name=$name]"><xsl:choose><xsl:when test="boolean(@of)"><xsl:call-template name="book:_get_object"><xsl:with-param name="path" select="@of"/><xsl:with-param name="what" select="@what"/><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="index" select="$data_index"/><xsl:with-param name="index_set" select="$data_indexes"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:apply-templates><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:otherwise></xsl:choose></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template match="for[boolean(@times) or boolean(attr/@name='times')]"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="deny"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_times"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">times</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_index_id"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">index</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:for_times"><xsl:with-param name="times" select="$_times"/><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="index_id" select="$_index_id"/><xsl:with-param name="index_set" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny">|attr|</xsl:with-param><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:template><xsl:template match="if"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_what"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">what</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_result"><xsl:call-template name="book:_get_object"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what" select="$_what"/><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="index" select="$data_index"/><xsl:with-param name="index_set" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_is_not_matched"><xsl:call-template name="book:_is_not_matched"><xsl:with-param name="object" select="$_result"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="boolean(then|else)"><xsl:choose><xsl:when test="string-length($_is_not_matched) = 0"><xsl:apply-templates select="then"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="'|attr|else|'"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates select="else"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="deny" select="'|attr|then|'"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:otherwise></xsl:choose></xsl:when><xsl:when test="string-length($_is_not_matched) = 0"><xsl:apply-templates select="text()|*[name()!='attr']"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:when></xsl:choose></xsl:template><xsl:template name="book:_is_not_matched"><xsl:param name="object"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:if test="boolean(@eq)"><xsl:if test="$object != @eq">1</xsl:if></xsl:if><xsl:if test="boolean(@ne)"><xsl:if test="$object = @ne">1</xsl:if></xsl:if><xsl:if test="boolean(@le)"><xsl:if test="$object &gt; @le">1</xsl:if></xsl:if><xsl:if test="boolean(@lt)"><xsl:if test="$object &gt;= @lt">1</xsl:if></xsl:if><xsl:if test="boolean(@ge)"><xsl:if test="$object &lt; @ge">1</xsl:if></xsl:if><xsl:if test="boolean(@gt)"><xsl:if test="$object &lt;= @gt">1</xsl:if></xsl:if><xsl:if test="boolean(attr[@name='eq'])"><xsl:variable name="_eq"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">eq</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:if test="$object != $_eq">1</xsl:if></xsl:if><xsl:if test="boolean(attr[@name='ne'])"><xsl:variable name="_ne"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">ne</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:if test="$object = $_ne">1</xsl:if></xsl:if><xsl:if test="boolean(attr[@name='le'])"><xsl:variable name="_le"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">le</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:if test="$object &gt; $_le">1</xsl:if></xsl:if><xsl:if test="boolean(attr[@name='lt'])"><xsl:variable name="_lt"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">lt</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:if test="$object &gt;= $_lt">1</xsl:if></xsl:if><xsl:if test="boolean(attr[@name='ge'])"><xsl:variable name="_ge"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">ge</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:if test="$object &lt; $_ge">1</xsl:if></xsl:if><xsl:if test="boolean(attr[@name='gt'])"><xsl:variable name="_gt"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">gt</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:if test="$object &lt;= $_gt">1</xsl:if></xsl:if></xsl:template><xsl:template name="book:get_data_gid"><xsl:param name="data_gid"/><xsl:if test="not(boolean(@data-src))"><xsl:value-of select="$data_gid"/></xsl:if></xsl:template><xsl:template match="sum"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_sum"><xsl:call-template name="_calc_sum"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/></xsl:call-template></xsl:variable><xsl:value-of select="$_prefix"/><xsl:value-of select="$_sum"/><xsl:value-of select="$_suffix"/></xsl:template><xsl:template name="_calc_sum"><xsl:param name="path"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:variable name="_numbers"><xsl:call-template name="do:get_objects_by_path"><xsl:with-param name="path" select="$path"/><xsl:with-param name="what">number</xsl:with-param><xsl:with-param name="prefix"/><xsl:with-param name="suffix">|</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:call-template name="_calc_sum_rcr"><xsl:with-param name="sum">0</xsl:with-param><xsl:with-param name="nums" select="$_numbers"/></xsl:call-template></xsl:template><xsl:template name="_calc_sum_rcr"><xsl:param name="sum"/><xsl:param name="nums"/><xsl:variable name="_num" select="substring-before($nums, '|')"/><xsl:variable name="_nums" select="substring-after($nums, '|')"/><xsl:choose><xsl:when test="string-length($nums) = 0"><xsl:value-of select="$sum"/></xsl:when><xsl:when test="$_num = 'NaN'"><xsl:call-template name="_calc_sum_rcr"><xsl:with-param name="sum" select="$sum"/><xsl:with-param name="nums" select="$_nums"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:call-template name="_calc_sum_rcr"><xsl:with-param name="sum" select="$sum + $_num"/><xsl:with-param name="nums" select="$_nums"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:template><xsl:template match="name"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">name</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:template><xsl:template name="book:_get_object"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="index"/><xsl:param name="index_set"/><xsl:param name="path"/><xsl:param name="what"/><xsl:choose><xsl:when test="string-length($what) = 0"><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$path"/><xsl:with-param name="what">text</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:when><xsl:when test="$what = 'index'"><xsl:call-template name="book:_get_index"><xsl:with-param name="index" select="$index"/><xsl:with-param name="index_set" select="$index_set"/><xsl:with-param name="index_id" select="$path"/></xsl:call-template></xsl:when><xsl:when test="$what = 'count'"><xsl:call-template name="do:count_nodes_by_path"><xsl:with-param name="path" select="$path"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:when><xsl:when test="$what = 'sum'"><xsl:call-template name="_calc_sum"><xsl:with-param name="path" select="$path"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:when><xsl:when test="$what = 'value'"><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$path"/><xsl:with-param name="what">text</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:when><xsl:when test="$what = 'text'"/><xsl:otherwise><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$path"/><xsl:with-param name="what" select="$what"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:template><xsl:template match="values"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_sep"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">separator</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:value-of select="$_sep"/><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_result"><xsl:call-template name="do:get_objects_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">text</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:variable><xsl:value-of select="substring($_result, string-length($_sep) + 1)"/></xsl:template><xsl:template match="index"><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:variable name="_index_id"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_index"><xsl:call-template name="book:_get_index"><xsl:with-param name="index" select="$data_index"/><xsl:with-param name="index_set" select="$data_indexes"/><xsl:with-param name="index_id" select="$_index_id"/></xsl:call-template></xsl:variable><xsl:if test="string-length($_index) != 0"><xsl:value-of select="$_prefix"/><xsl:value-of select="$_index"/><xsl:value-of select="$_suffix"/></xsl:if></xsl:template><xsl:template name="book:_get_index"><xsl:param name="index"/><xsl:param name="index_set"/><xsl:param name="index_id"/><xsl:choose><xsl:when test="string-length($index_id) = 0"><xsl:value-of select="$index"/></xsl:when><xsl:otherwise><xsl:value-of select="substring-before(substring-after($index_set, concat($do:_object_sep, $index_id, $do:_cond_op_sep)), $do:_object_sep)"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template match="number"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">number</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:template><xsl:template match="contents"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_sep"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">separator</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:value-of select="$_sep"/><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_result"><xsl:call-template name="do:get_objects_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">content</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:variable><xsl:value-of select="substring($_result, string-length($_sep) + 1)"/></xsl:template><xsl:template match="choose"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node" select="$ut:true"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_result"><xsl:if test="not(boolean(when/@of) or boolean(when/attr[@name='of']))"><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_what"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">what</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="book:_get_object"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what" select="$_what"/><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="index" select="$data_index"/><xsl:with-param name="index_set" select="$data_indexes"/></xsl:call-template></xsl:if></xsl:variable><xsl:variable name="_when_count"><xsl:value-of select="count(when)"/></xsl:variable><xsl:for-each select="when[1]"><xsl:call-template name="book:_choose_when"><xsl:with-param name="result" select="$_result"/><xsl:with-param name="when_index" select="1"/><xsl:with-param name="when_count" select="$_when_count"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:for-each></xsl:template><xsl:template name="book:_choose_when"><xsl:param name="result"/><xsl:param name="when_index"/><xsl:param name="when_count"/><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="allow"/><xsl:param name="allow_text_node"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_result"><xsl:choose><xsl:when test="boolean(@of) or boolean(attr[@name='of']) or boolean(@what) or boolean(attr[@name='what'])"><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_what"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">what</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="book:_get_object"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="index_set" select="$data_indexes"/><xsl:with-param name="index" select="$data_index"/><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what" select="$_what"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:value-of select="$result"/></xsl:otherwise></xsl:choose></xsl:variable><xsl:variable name="_is_not_matched"><xsl:call-template name="book:_is_not_matched"><xsl:with-param name="object" select="$_result"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="string-length($_is_not_matched) = 0"><xsl:apply-templates select="text()|*[name()!='attr']"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:when><xsl:when test="$when_index &lt; $when_count"><xsl:for-each select="../when[position() = $when_index + 1]"><xsl:call-template name="book:_choose_when"><xsl:with-param name="result" select="$result"/><xsl:with-param name="when_index" select="$when_index + 1"/><xsl:with-param name="when_count" select="$when_count"/><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:for-each></xsl:when><xsl:otherwise><xsl:for-each select="../otherwise[1]"><xsl:apply-templates select="text()|*[name()!='attr']"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="allow" select="$allow"/><xsl:with-param name="allow_text_node" select="$allow_text_node"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:apply-templates></xsl:for-each></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="book:get_data_url"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:choose><xsl:when test="boolean(@data-src)"><xsl:value-of select="@data-src"/></xsl:when><xsl:when test="boolean(attr[@name='data-src'])"><xsl:apply-templates select="attr[@name='data-src']"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:value-of select="$data_url"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template match="content"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">content</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:template><xsl:template match="numbers"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_sep"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">separator</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:value-of select="$_sep"/><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_result"><xsl:call-template name="do:get_objects_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">number</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:variable><xsl:value-of select="substring($_result, string-length($_sep) + 1)"/></xsl:template><xsl:template match="value"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:call-template name="do:first_object_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">text</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:template><xsl:template match="names"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_data_gid"><xsl:call-template name="book:get_data_gid"><xsl:with-param name="data_gid" select="$data_gid"/></xsl:call-template></xsl:variable><xsl:variable name="_path"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">of</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_sep"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">separator</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_prefix"><xsl:value-of select="$_sep"/><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/></xsl:call-template></xsl:variable><xsl:variable name="_result"><xsl:call-template name="do:get_objects_by_path"><xsl:with-param name="path" select="$_path"/><xsl:with-param name="what">name</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="data_gid" select="$_data_gid"/><xsl:with-param name="prefix" select="$_prefix"/><xsl:with-param name="suffix" select="$_suffix"/></xsl:call-template></xsl:variable><xsl:value-of select="substring($_result, string-length($_sep) + 1)"/></xsl:template><xsl:template match="title" mode="xslbook"><xsl:param name="data_url"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:variable name="_id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:variable><h1 class="title xslbook-title"><xsl:attribute name="id"><xsl:value-of select="$_id"/></xsl:attribute><xsl:for-each select="../subtitle[@top-of=$_id]"><div class="subtitle xslbook-subtitle top-of-title"><xsl:attribute name="id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:attribute><xsl:call-template name="book:_get_book_title_text_updating_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></div></xsl:for-each><xsl:for-each select="../subtitle[@left-of=$_id]"><span class="subtitle xslbook-subtitle left-of-title"><xsl:attribute name="id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:attribute><xsl:call-template name="book:_get_book_title_text_updating_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></span><xsl:value-of select="' '"/></xsl:for-each><xsl:call-template name="book:_get_book_title_text"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template><xsl:for-each select="../subtitle[@right-of=$_id]"><xsl:value-of select="' '"/><span class="subtitle xslbook-subtitle right-of-title"><xsl:attribute name="id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:attribute><xsl:call-template name="book:_get_book_title_text_updating_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></span></xsl:for-each><xsl:for-each select="../subtitle[@bottom-of=$_id]"><div class="subtitle xslbook-subtitle bottom-of-title"><xsl:attribute name="id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:attribute><xsl:call-template name="book:_get_book_title_text_updating_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></div></xsl:for-each></h1></xsl:template><xsl:template match="subtitle[not(@top-of or @left-of or @right-of or @bottom-of)]" mode="xslbook"><xsl:param name="data_url"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:variable name="_id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:variable><div class="subtitle xslbook-subtitle"><xsl:attribute name="id"><xsl:value-of select="$_id"/></xsl:attribute><xsl:call-template name="book:_get_book_title_text"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></div></xsl:template><xsl:template name="book:_get_book_title_text"><xsl:param name="data_url"/><span class="prefix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></span><xsl:apply-templates select="child::node()[name() != 'attr']"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates><span class="suffix"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></span></xsl:template><xsl:template name="book:_get_book_title_text_updating_data_url"><xsl:param name="data_url"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:call-template name="book:_get_book_title_text"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:template><xsl:template match="body" mode="xslbook"><xsl:param name="data_url"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:variable name="_id"><xsl:call-template name="book:get_id"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:variable><div class="body xslbook-body"><xsl:attribute name="id"><xsl:value-of select="$_id"/></xsl:attribute><xsl:apply-templates select="child::node()[name() != 'attr']"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></div></xsl:template><xsl:template name="book:get_window_title"><xsl:param name="data_url"/><xsl:variable name="_title"><xsl:for-each select="title|subtitle[not(@spine='false')]"><xsl:value-of select="' '"/><xsl:call-template name="book:_get_book_title_label"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:for-each></xsl:variable><xsl:value-of select="substring($_title, 2)"/></xsl:template><xsl:template name="book:_get_book_title_label"><xsl:param name="data_url"/><xsl:variable name="_data_url"><xsl:call-template name="book:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:call-template name="book:get_attr"><xsl:with-param name="name">prefix</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template><xsl:apply-templates><xsl:with-param name="data_url" select="$_data_url"/></xsl:apply-templates><xsl:call-template name="book:get_attr"><xsl:with-param name="name">suffix</xsl:with-param><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template></xsl:template><xsl:template name="book:get_id"><xsl:param name="data_url"/><xsl:param name="data_gid"/><xsl:param name="data_index"/><xsl:param name="data_indexes"/><xsl:param name="arg0"/><xsl:param name="arg1"/><xsl:param name="arg2"/><xsl:variable name="_id"><xsl:call-template name="book:get_attr"><xsl:with-param name="name">id</xsl:with-param><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="data_gid" select="$data_gid"/><xsl:with-param name="data_index" select="$data_index"/><xsl:with-param name="data_indexes" select="$data_indexes"/><xsl:with-param name="arg0" select="$arg0"/><xsl:with-param name="arg1" select="$arg1"/><xsl:with-param name="arg2" select="$arg2"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="string-length($_id) != 0"><xsl:value-of select="$_id"/></xsl:when><xsl:otherwise><xsl:text>idxbk</xsl:text><xsl:variable name="_tag_name" select="local-name()"/><xsl:value-of select="$_tag_name"/><xsl:number level="any" format="1" count="*[name() = $_tag_name]"/></xsl:otherwise></xsl:choose></xsl:template></xsl:stylesheet>